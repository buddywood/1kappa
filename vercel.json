import React, { useState, useEffect } from "react";
import {
  Dialog,
  DialogContent,
  DialogTitle,
  DialogDescription,
} from "@reach/dialog";
import { HoldSyncLogo } from "./HoldSyncLogo";
import { Input } from "./Input";
import { Button } from "./Button";

interface EmailVerificationModalProps {
  email: string;
  isOpen: boolean;
  onClose: () => void;
  onVerified: () => void;
}

export const EmailVerificationModal: React.FC<EmailVerificationModalProps> = ({
  email,
  isOpen,
  onClose,
  onVerified,
}) => {
  const [pin, setPin] = useState("");
  const [timeRemaining, setTimeRemaining] = useState(300);
  const [isVerifying, setIsVerifying] = useState(false);
  const [isResending, setIsResending] = useState(false);

  useEffect(() => {
    if (!isOpen) {
      setPin("");
      setTimeRemaining(300);
    }
  }, [isOpen]);

  useEffect(() => {
    if (!isOpen) return;
    if (timeRemaining === 0) return;

    const timer = setInterval(() => {
      setTimeRemaining((prev) => prev - 1);
    }, 1000);

    return () => clearInterval(timer);
  }, [isOpen, timeRemaining]);

  const formatTime = (seconds: number) => {
    const m = Math.floor(seconds / 60)
      .toString()
      .padStart(2, "0");
    const s = (seconds % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  };

  const handlePinChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    if (/^\d*$/.test(value) && value.length <= 6) {
      setPin(value);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter") {
      handleVerifyPin();
    }
  };

  const handleVerifyPin = async () => {
    if (pin.length !== 6) return;
    setIsVerifying(true);
    try {
      // Simulate API call
      await new Promise((r) => setTimeout(r, 1000));
      onVerified();
      onClose();
    } catch {
      // Handle error
    } finally {
      setIsVerifying(false);
    }
  };

  const handleResendPin = async () => {
    setIsResending(true);
    try {
      // Simulate API call
      await new Promise((r) => setTimeout(r, 1000));
      setTimeRemaining(300);
      setPin("");
    } catch {
      // Handle error
    } finally {
      setIsResending(false);
    }
  };

  return (
    <Dialog isOpen={isOpen} onDismiss={onClose} className="max-w-md mx-auto rounded-2xl bg-white shadow-lg">
      <DialogContent className="p-0">
        {/* Header */}
        <div className="px-8 pt-8 pb-6 text-center bg-white">
          <div className="flex justify-center mb-4">
            <div className="w-20 h-20 rounded-2xl bg-white shadow-md flex items-center justify-center">
              <HoldSyncLogo variant="icon" className="w-10 h-10 text-[#2563EB]" />
            </div>
          </div>

          <DialogTitle className="text-h3 font-bold text-slate-900 mb-2">
            Welcome to HoldSync! ðŸŽ‰
          </DialogTitle>

          <DialogDescription className="text-slate-600 text-body-medium max-w-xs mx-auto">
            To keep your calendar data secure, we need to verify your email address.
          </DialogDescription>

          <p className="text-slate-600 text-body-medium mt-3">
            Weâ€™ve sent a 6â€‘digit verification code to:
          </p>

          <p className="text-slate-900 font-semibold text-h5 mt-1">{email}</p>
        </div>

        <div className="flex justify-center mb-6">
          <div className="px-4 py-2 rounded-full bg-red-50 text-red-600 text-body-medium border border-red-200 flex items-center gap-2">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            PIN expires in {formatTime(timeRemaining)}
          </div>
        </div>

        <div className="flex justify-center mb-6">
          <Input
            type="text"
            value={pin}
            onChange={handlePinChange}
            onKeyPress={handleKeyPress}
            placeholder="000000"
            className="w-56 text-center text-h3 font-mono tracking-widest rounded-2xl border border-slate-300 focus:ring-2 focus:ring-[#2563EB] focus:border-[#2563EB]"
            maxLength={6}
            disabled={isVerifying || timeRemaining === 0}
          />
        </div>

        <div className="px-8 space-y-4 mb-6">
          <button
            onClick={handleVerifyPin}
            disabled={isVerifying || pin.length !== 6 || timeRemaining === 0}
            className="w-full bg-[#2563EB] text-white py-3 rounded-2xl font-medium shadow-sm hover:bg-[#1D4ED8] disabled:bg-slate-300 transition flex items-center justify-center"
          >
            {isVerifying ? "Verifying..." : "Verify"}
          </button>

          <Button
            onClick={handleResendPin}
            disabled={isResending}
            variant="secondary"
            className="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-2xl"
          >
            {isResending ? "Resending..." : "Resend PIN"}
          </Button>
        </div>

        <div className="px-8 pb-8 text-center text-slate-500 text-body-small">
          <p>
            Didnâ€™t receive the email? Check your spam folder or{" "}
            <button onClick={onClose} className="text-[#2563EB] underline">
              contact support
            </button>
            .
          </p>
        </div>
      </DialogContent>
    </Dialog>
  );
};
